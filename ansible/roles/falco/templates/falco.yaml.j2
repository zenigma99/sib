# ==============================================
# Falco Configuration for SIB Fleet Agent
# ==============================================
# Generated by Ansible - Do not edit directly
# Host: {{ inventory_hostname }}
# mTLS: {{ mtls_enabled | default(false) }}
# ==============================================

# ---------------------------------------------
# Engine Configuration
# ---------------------------------------------

engine:
  kind: modern_ebpf
  modern_ebpf:
    cpus_for_each_buffer: 2
    buf_size_preset: 4

# ---------------------------------------------
# Output Configuration
# ---------------------------------------------

json_output: true
json_include_output_property: true
json_include_tags_property: true
time_format_iso_8601: true

# ---------------------------------------------
# HTTP Output (to Falcosidekick)
# ---------------------------------------------

http_output:
  enabled: {{ falco_outputs.http_enabled | default(true) | lower }}
  url: "{{ falco_outputs.http_url }}"
  user_agent: "falco/{{ falco_version }}"
{% if mtls_enabled | default(false) | bool %}
  # mTLS client configuration
  insecure: false
  ca_cert: {{ mtls_ca_cert }}
  client_cert: {{ mtls_client_cert }}
  client_key: {{ mtls_client_key }}
  mtls: true
{% endif %}

# ---------------------------------------------
# Priority & Filtering
# ---------------------------------------------

priority: {{ falco_priority | default('notice') }}

# ---------------------------------------------
# Rules Configuration
# ---------------------------------------------

rules_files:
  - /etc/falco/falco_rules.yaml
  - /etc/falco/falco_rules.local.yaml
  - /etc/falco/rules.d

watch_config_files: true

# ---------------------------------------------
# Performance Tuning
# ---------------------------------------------

buffered_outputs: true
output_timeout: 2000

# ---------------------------------------------
# gRPC Configuration
# ---------------------------------------------

grpc:
  enabled: false
  bind_address: "unix:///run/falco/falco.sock"
  threadiness: 0

grpc_output:
  enabled: false

# ---------------------------------------------
# Webserver (for health checks)
# ---------------------------------------------

webserver:
  enabled: true
  listen_port: 8765
  k8s_healthz_endpoint: /healthz
  ssl_enabled: false

# ---------------------------------------------
# Metrics
# ---------------------------------------------

metrics:
  enabled: true
  interval: 1h
  output_rule: true
  rules_counters_enabled: true
  resource_utilization_enabled: true
  state_counters_enabled: true
  kernel_event_counters_enabled: true
  libbpf_stats_enabled: true
  convert_memory_to_mb: true
  include_empty_values: false

# ---------------------------------------------
# Syscall Event Source
# ---------------------------------------------

syscall_event_drops:
  threshold: 0.1
  actions:
    - log
    - alert
  rate: 0.03333
  max_burst: 1

# ---------------------------------------------
# Container Runtime
# ---------------------------------------------

container_engines:
  docker:
    enabled: true
  cri:
    enabled: false
  podman:
    enabled: false
  lxc:
    enabled: false
  libvirt_lxc:
    enabled: false
  bpm:
    enabled: false

# ---------------------------------------------
# Logging
# ---------------------------------------------

log_stderr: true
log_syslog: false
log_level: {{ log_level | default('info') }}

# ---------------------------------------------
# Base Syscalls
# ---------------------------------------------

base_syscalls:
  custom_set: []
  repair: false
