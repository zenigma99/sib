# Falco native installation
---

- name: Add Falco GPG key (Debian/Ubuntu)
  ansible.builtin.apt_key:
    url: https://falco.org/repo/falcosecurity-packages.asc
    state: present
  when: ansible_os_family == 'Debian'
  tags: falco

- name: Add Falco repository (Debian/Ubuntu)
  ansible.builtin.apt_repository:
    repo: "deb https://download.falco.org/packages/deb stable main"
    state: present
    filename: falcosecurity
  when: ansible_os_family == 'Debian'
  tags: falco

- name: Add Falco repository (RHEL/CentOS)
  ansible.builtin.yum_repository:
    name: falcosecurity
    description: Falco Security Repository
    baseurl: https://download.falco.org/packages/rpm/
    gpgcheck: true
    gpgkey: https://falco.org/repo/falcosecurity-packages.asc
    enabled: true
  when: ansible_os_family == 'RedHat'
  tags: falco

- name: Install kernel headers (Debian/Ubuntu)
  ansible.builtin.apt:
    name: "linux-headers-{{ ansible_kernel }}"
    state: present
  when: ansible_os_family == 'Debian'
  ignore_errors: true
  tags: falco

- name: Install kernel headers (RHEL/CentOS)
  ansible.builtin.yum:
    name: "kernel-devel-{{ ansible_kernel }}"
    state: present
  when: ansible_os_family == 'RedHat'
  ignore_errors: true
  tags: falco

- name: Install Falco (Debian/Ubuntu)
  ansible.builtin.apt:
    name: falco
    state: present
    update_cache: true
  when: ansible_os_family == 'Debian'
  tags: falco

- name: Install Falco (RHEL/CentOS)
  ansible.builtin.yum:
    name: falco
    state: present
  when: ansible_os_family == 'RedHat'
  tags: falco

- name: Install Falco container plugin
  ansible.builtin.command:
    cmd: falcoctl artifact install container --no-verify
  args:
    creates: /usr/share/falco/plugins/libcontainer.so
  tags: falco

- name: Deploy Falco configuration
  ansible.builtin.template:
    src: falco.yaml.j2
    dest: /etc/falco/falco.yaml
    owner: root
    group: root
    mode: '0644'
  notify: Restart Falco
  tags: falco

- name: Deploy custom rules
  ansible.builtin.copy:
    src: "/detection-config/rules/{{ item }}"
    dest: "/etc/falco/rules.d/{{ item }}"
    owner: root
    group: root
    mode: '0644'
  loop: "{{ falco_custom_rules }}"
  notify: Restart Falco
  ignore_errors: true
  tags: falco

- name: Enable and start Falco service (modern-bpf)
  ansible.builtin.service:
    name: falco-modern-bpf
    state: started
    enabled: true
  register: falco_modern_service
  ignore_errors: true
  tags: falco

- name: Enable and start Falco service (legacy fallback)
  ansible.builtin.service:
    name: falco
    state: started
    enabled: true
  when: falco_modern_service is failed
  tags: falco

- name: Verify Falco is running
  ansible.builtin.shell: systemctl is-active falco-modern-bpf || systemctl is-active falco
  register: falco_native_status
  changed_when: false
  failed_when: falco_native_status.rc != 0
  tags: falco
