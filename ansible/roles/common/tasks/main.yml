# Common role - prerequisites and base setup
---

# ============================================================================
# Detect Docker & Set Deployment Facts
# ============================================================================

- name: Check if Docker is installed
  ansible.builtin.command: docker --version
  register: docker_check
  changed_when: false
  failed_when: false
  tags: always

- name: Check if Docker daemon is running
  ansible.builtin.command: docker info
  register: docker_running
  changed_when: false
  failed_when: false
  when: docker_check.rc == 0
  tags: always

- name: Set Docker availability fact
  ansible.builtin.set_fact:
    docker_available: "{{ docker_check.rc == 0 and (docker_running.rc | default(1)) == 0 }}"
    docker_installed: "{{ docker_check.rc == 0 }}"
  tags: always

- name: Display Docker status
  ansible.builtin.debug:
    msg: >-
      Docker installed: {{ docker_installed | bool }}
      | Docker running: {{ docker_available | bool }}
      | Strategy: {{ deployment_strategy }}
      | Will install Docker: {{ (deployment_strategy == 'docker' or (deployment_strategy == 'auto' and install_docker_if_missing)) and not docker_available }}
  tags: always

# ============================================================================
# Determine effective deployment method
# ============================================================================

- name: Set effective deployment method
  ansible.builtin.set_fact:
    effective_deployment: >-
      {%- if deployment_strategy == 'native' -%}
        native
      {%- elif deployment_strategy == 'docker' -%}
        docker
      {%- elif docker_available -%}
        docker
      {%- elif install_docker_if_missing -%}
        docker
      {%- else -%}
        native
      {%- endif -%}
  tags: always

- name: Display effective deployment method
  ansible.builtin.debug:
    msg: "Effective deployment method: {{ effective_deployment | trim }}"
  tags: always

# ============================================================================
# Package Installation
# ============================================================================

- name: Update package cache (Debian/Ubuntu)
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 3600
  when: ansible_os_family == 'Debian'
  tags: packages

- name: Update package cache (RHEL/CentOS)
  ansible.builtin.yum:
    update_cache: true
  when: ansible_os_family == 'RedHat'
  tags: packages

- name: Install common packages (Debian/Ubuntu)
  ansible.builtin.apt:
    name:
      - curl
      - wget
      - ca-certificates
      - gnupg
      - iptables
      - python3-requests
    state: present
  when: ansible_os_family == 'Debian'
  tags: packages

- name: Install common packages (RHEL/CentOS)
  ansible.builtin.yum:
    name:
      - curl
      - wget
      - ca-certificates
      - iptables
    state: present
  when: ansible_os_family == 'RedHat'
  tags: packages

# ============================================================================
# Docker Installation - Static Binary Method (only if needed)
# ============================================================================

- name: Install Docker from static binaries
  when: 
    - effective_deployment | trim == 'docker'
    - not docker_available
  block:
    - name: Set Docker version
      ansible.builtin.set_fact:
        docker_version: "{{ docker_static_version | default('24.0.7') }}"
        docker_arch: "{{ 'x86_64' if ansible_architecture == 'x86_64' else 'aarch64' if ansible_architecture == 'aarch64' else ansible_architecture }}"
      tags: docker

    - name: Create Docker directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: root
        group: root
        mode: '0755'
      loop:
        - /opt/docker
        - /etc/docker
        - /var/lib/docker
        - /var/run/docker
      tags: docker

    - name: Download Docker static binaries
      ansible.builtin.get_url:
        url: "https://download.docker.com/linux/static/stable/{{ docker_arch }}/docker-{{ docker_version }}.tgz"
        dest: /tmp/docker-{{ docker_version }}.tgz
        mode: '0644'
      tags: docker

    - name: Extract Docker binaries
      ansible.builtin.unarchive:
        src: /tmp/docker-{{ docker_version }}.tgz
        dest: /opt/docker
        remote_src: true
        extra_opts:
          - --strip-components=1
      tags: docker

    - name: Create symlinks to Docker binaries
      ansible.builtin.file:
        src: "/opt/docker/{{ item }}"
        dest: "/usr/local/bin/{{ item }}"
        state: link
      loop:
        - docker
        - dockerd
        - docker-proxy
        - containerd
        - containerd-shim-runc-v2
        - ctr
        - runc
      tags: docker

    - name: Create docker group
      ansible.builtin.group:
        name: docker
        state: present
      tags: docker

    - name: Create containerd systemd service
      ansible.builtin.copy:
        dest: /etc/systemd/system/containerd.service
        owner: root
        group: root
        mode: '0644'
        content: |
          [Unit]
          Description=containerd container runtime
          Documentation=https://containerd.io
          After=network.target local-fs.target

          [Service]
          ExecStart=/usr/local/bin/containerd
          Type=notify
          Delegate=yes
          KillMode=process
          Restart=always
          RestartSec=5
          LimitNPROC=infinity
          LimitCORE=infinity
          LimitNOFILE=1048576
          TasksMax=infinity
          OOMScoreAdjust=-999

          [Install]
          WantedBy=multi-user.target
      notify: Reload systemd
      tags: docker

    - name: Create Docker systemd service
      ansible.builtin.copy:
        dest: /etc/systemd/system/docker.service
        owner: root
        group: root
        mode: '0644'
        content: |
          [Unit]
          Description=Docker Application Container Engine
          Documentation=https://docs.docker.com
          After=network-online.target containerd.service
          Wants=network-online.target
          Requires=containerd.service

          [Service]
          Type=notify
          ExecStart=/usr/local/bin/dockerd --containerd=/run/containerd/containerd.sock
          ExecReload=/bin/kill -s HUP $MAINPID
          TimeoutSec=0
          RestartSec=2
          Restart=always
          StartLimitBurst=3
          StartLimitInterval=60s
          LimitNOFILE=infinity
          LimitNPROC=infinity
          LimitCORE=infinity
          TasksMax=infinity
          Delegate=yes
          KillMode=process
          OOMScoreAdjust=-500

          [Install]
          WantedBy=multi-user.target
      notify: Reload systemd
      tags: docker

    - name: Create Docker socket systemd unit
      ansible.builtin.copy:
        dest: /etc/systemd/system/docker.socket
        owner: root
        group: root
        mode: '0644'
        content: |
          [Unit]
          Description=Docker Socket for the API

          [Socket]
          ListenStream=/var/run/docker.sock
          SocketMode=0660
          SocketUser=root
          SocketGroup=docker

          [Install]
          WantedBy=sockets.target
      notify: Reload systemd
      tags: docker

    - name: Create Docker daemon configuration
      ansible.builtin.copy:
        dest: /etc/docker/daemon.json
        owner: root
        group: root
        mode: '0644'
        content: |
          {
            "storage-driver": "overlay2",
            "log-driver": "json-file",
            "log-opts": {
              "max-size": "10m",
              "max-file": "3"
            }
          }
      tags: docker

    - name: Reload systemd daemon
      ansible.builtin.systemd:
        daemon_reload: true
      tags: docker

    - name: Enable and start containerd
      ansible.builtin.systemd:
        name: containerd
        state: started
        enabled: true
      tags: docker

    - name: Enable and start Docker
      ansible.builtin.systemd:
        name: docker
        state: started
        enabled: true
      tags: docker

    - name: Clean up downloaded archive
      ansible.builtin.file:
        path: /tmp/docker-{{ docker_version }}.tgz
        state: absent
      tags: docker

    - name: Verify Docker installation
      ansible.builtin.command: docker --version
      register: docker_verify
      changed_when: false
      tags: docker

    - name: Display Docker version
      ansible.builtin.debug:
        msg: "Docker installed successfully: {{ docker_verify.stdout }}"
      tags: docker

    - name: Update docker_available fact after installation
      ansible.builtin.set_fact:
        docker_available: true
      tags: docker

# ============================================================================
# Common Setup
# ============================================================================

- name: Create SIB directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  loop:
    - /etc/sib
    - /var/log/sib
  tags: setup

- name: Set timezone
  community.general.timezone:
    name: "{{ timezone }}"
  when: timezone is defined
  tags: setup

- name: Create SIB Docker network
  community.docker.docker_network:
    name: "{{ docker_network }}"
    state: present
  when: docker_available | bool
  tags: docker
